---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Retos de Maestría - Capítulo 4">
  <div class="max-w-4xl mx-auto">
    <div class="mb-10">
      <div class="inline-block px-3 py-1 bg-primary/10 text-primary text-xs font-bold rounded-full mb-3 tracking-wider uppercase">
        Capítulo 4
      </div>
      <h1 class="text-3xl font-black text-slate-900 mb-4">
        Action Time: Retos de Maestría
      </h1>
      <p class="text-lg text-slate-600 leading-relaxed">
        El conocimiento sin acción es ilusión. Completa estos retos para validar tu transformación.
      </p>
    </div>

    <div class="grid gap-8">
      
      <!-- Challenge 1 -->
      <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-xl shadow-slate-200/50">
        <h3 class="text-xl font-bold text-slate-900 mb-2">Reto de Decisión Anticipada</h3>
        <p class="text-slate-600 mb-6 text-sm">Planifica tu día la noche anterior durante 7 días consecutivos.</p>
        
        <div class="flex justify-between items-center gap-2" id="challenge-decision">
          {[1, 2, 3, 4, 5, 6, 7].map((day) => (
            <button class="w-10 h-10 rounded-full border-2 border-slate-200 flex items-center justify-center text-slate-400 font-bold hover:border-primary hover:text-primary transition-all day-btn" data-type="decision" data-day={day}>
              {day}
            </button>
          ))}
        </div>
      </div>

      <!-- Challenge 2 -->
      <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-xl shadow-slate-200/50">
        <h3 class="text-xl font-bold text-slate-900 mb-2">Reto del Entorno</h3>
        <p class="text-slate-600 mb-6 text-sm">Elimina una distracción física o digital de tu entorno cada día.</p>
        
        <div class="flex justify-between items-center gap-2" id="challenge-environment">
          {[1, 2, 3, 4, 5, 6, 7].map((day) => (
            <button class="w-10 h-10 rounded-full border-2 border-slate-200 flex items-center justify-center text-slate-400 font-bold hover:border-primary hover:text-primary transition-all day-btn" data-type="environment" data-day={day}>
              {day}
            </button>
          ))}
        </div>
      </div>

      <!-- Challenge 3 -->
      <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-xl shadow-slate-200/50">
        <h3 class="text-xl font-bold text-slate-900 mb-2">Reto de la Praxis</h3>
        <p class="text-slate-600 mb-6 text-sm">Aplica un concepto aprendido en el libro inmediatamente en tu negocio.</p>
        
        <div class="flex justify-between items-center gap-2" id="challenge-praxis">
          {[1, 2, 3, 4, 5, 6, 7].map((day) => (
            <button class="w-10 h-10 rounded-full border-2 border-slate-200 flex items-center justify-center text-slate-400 font-bold hover:border-primary hover:text-primary transition-all day-btn" data-type="praxis" data-day={day}>
              {day}
            </button>
          ))}
        </div>
      </div>

    </div>
  </div>
</DashboardLayout>

<script>
  // Simple tracker logic - In a real app, this would load state from API
  const buttons = document.querySelectorAll('.day-btn');

  // Load state (mocked for simplicity in this step, but wired to API structure)
  async function loadState() {
    try {
      const response = await fetch(`${window.API_URL}/exercises/challenges`, {
        credentials: 'include',
      });
      if (response.ok) {
        const data = await response.json();
        data.forEach((challenge: any) => {
          const container = document.getElementById(`challenge-${challenge.type}`);
          if (container) {
            const days = container.querySelectorAll('.day-btn');
            days.forEach((btn, idx) => {
              if (idx < challenge.daysCompleted) {
                btn.classList.add('bg-primary', 'text-white', 'border-primary');
                btn.classList.remove('text-slate-400', 'border-slate-200');
              }
            });
          }
        });
      }
    } catch (e) {}
  }
  loadState();

  buttons.forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.target as HTMLButtonElement;
      const type = button.dataset.type;
      const day = parseInt(button.dataset.day || '0');
      
      // Visual update immediately for better UX
      const container = button.parentElement;
      const allButtons = container?.querySelectorAll('.day-btn');
      
      // Toggle logic: click day 3 sets 1, 2, 3 as active
      allButtons?.forEach((b, idx) => {
        if (idx < day) {
          b.classList.add('bg-primary', 'text-white', 'border-primary');
          b.classList.remove('text-slate-400', 'border-slate-200');
        } else {
          b.classList.remove('bg-primary', 'text-white', 'border-primary');
          b.classList.add('text-slate-400', 'border-slate-200');
        }
      });

      // API Call
      try {
        await fetch(`${window.API_URL}/exercises/challenges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ type, daysCompleted: day }),
        });
      } catch (error) {
        console.error('Error saving progress');
      }
    });
  });
</script>
